<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>360 Çekim (Kamerasız) - Web MVP</title>
  <meta name="description" content="Telefonla adım adım fotoğraf çekip 360 panorama üretmek için web tabanlı çekim arayüzü."/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220; --card:rgba(255,255,255,.08); --border:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.70);
      --ok:#26d07c; --warn:#ffcc00; --bad:#ff5a5f;
    }
    body{ background:var(--bg); color:var(--text); }
    .glass{ background:var(--card); border:1px solid var(--border); border-radius:16px; backdrop-filter: blur(10px); }
    .video-wrap{ position:relative; overflow:hidden; border-radius:18px; border:1px solid var(--border); background:#050912; }
    video{ width:100%; height:60vh; min-height:340px; object-fit:cover; display:block; }
    .hud{
      position:absolute; inset:0; pointer-events:none;
      display:flex; align-items:center; justify-content:center;
    }
    .reticle{
      width:140px; height:140px; border-radius:999px;
      border:2px dashed rgba(255,255,255,.35);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.20);
    }
    .dot{
      width:14px; height:14px; border-radius:999px;
      background: rgba(255,255,255,.5);
      box-shadow: 0 0 0 10px rgba(255,255,255,.10);
    }
    .statusbar{
      position:absolute; left:12px; right:12px; top:12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      pointer-events:auto;
    }
    .pill{
      border:1px solid var(--border); background:rgba(0,0,0,.35);
      border-radius:14px; padding:10px 12px; font-weight:600;
      display:flex; gap:10px; align-items:center;
    }
    .lamp{ width:10px; height:10px; border-radius:999px; background:var(--warn); }
    .lamp.ok{ background:var(--ok); box-shadow:0 0 0 6px rgba(38,208,124,.18); }
    .lamp.bad{ background:var(--bad); }
    .thumbs{ display:flex; gap:10px; overflow:auto; padding:10px; }
    .thumb{
      width:110px; height:80px; border-radius:12px; overflow:hidden;
      border:1px solid var(--border); background:#0b1220; flex:0 0 auto;
      position:relative;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb .n{
      position:absolute; left:6px; top:6px;
      background:rgba(0,0,0,.45); border:1px solid var(--border);
      padding:2px 7px; border-radius:10px; font-size:.8rem;
    }
    .smallmuted{ color:var(--muted); font-size:.92rem; }
    canvas{ display:none; }
  </style>
</head>
<body>

<div class="container py-3">
  <div class="glass p-3 mb-3">
    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <div>
        <h1 class="h4 mb-1">Kamerasız 360 Çekim (Web)</h1>
        <div class="smallmuted">Telefonu hedef açıya getir → çek → sonunda tüm kareleri stitch için gönderebilirsin.</div>
      </div>
      <div class="d-flex gap-2">
        <button id="btnStart" class="btn btn-primary">Kamerayı Aç</button>
        <button id="btnGyro" class="btn btn-outline-light">Gyro İzin</button>
      </div>
    </div>
  </div>

  <div class="video-wrap mb-3">
    <div class="statusbar">
      <div class="pill">
        <span class="lamp" id="lamp"></span>
        <span id="targetText">Hedef: —</span>
      </div>
      <div class="pill">
        <span>Yaw:</span><span id="yawVal">—</span>
        <span class="ms-2">Pitch:</span><span id="pitchVal">—</span>
      </div>
    </div>

    <video id="video" autoplay playsinline muted></video>

    <div class="hud">
      <div class="reticle">
        <div class="dot" id="dot"></div>
      </div>
    </div>
  </div>

  <div class="glass p-3 mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-lg-3">
        <label class="form-label">Adım (Yaw derece)</label>
        <input id="stepYaw" type="number" class="form-control" value="30" min="10" max="60">
        <div class="smallmuted mt-1">30° = 12 kare (360/30)</div>
      </div>
      <div class="col-lg-3">
        <label class="form-label">Tolerans (± derece)</label>
        <input id="tol" type="number" class="form-control" value="6" min="2" max="15">
        <div class="smallmuted mt-1">Hedefe yaklaşınca yeşil olur</div>
      </div>
      <div class="col-lg-3">
        <label class="form-label">Katman (Pitch)</label>
        <select id="layer" class="form-select">
          <option value="0">Orta (0°)</option>
          <option value="30">Yukarı (+30°)</option>
          <option value="-30">Aşağı (-30°)</option>
        </select>
        <div class="smallmuted mt-1">MVP için tek katman da yeter</div>
      </div>
      <div class="col-lg-3 d-grid">
        <button id="btnCapture" class="btn btn-success btn-lg">Foto Çek</button>
      </div>
    </div>
  </div>

  <div class="glass">
    <div class="p-3 border-bottom" style="border-color: rgba(255,255,255,.12)!important;">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div>
          <div class="fw-bold">Çekimler</div>
          <div class="smallmuted" id="progressText">0 kare</div>
        </div>
        <div class="d-flex gap-2">
          <button id="btnNextTarget" class="btn btn-outline-light">Sonraki Hedef</button>
          <button id="btnClear" class="btn btn-outline-danger">Temizle</button>
          <button id="btnDownload" class="btn btn-outline-info">Hepsini İndir</button>
          <button id="btnUpload" class="btn btn-warning">Sunucuya Gönder</button>
        </div>
      </div>
    </div>

    <div class="thumbs" id="thumbs"></div>
  </div>

  <canvas id="canvas"></canvas>

  <div class="smallmuted mt-3">
    <b>Not:</b> Tarayıcı içinde kaliteli 360 stitch ağırdır. MVP’de kareleri sunucuya yollayıp
    sunucuda tek bir <b>2:1 equirectangular</b> panorama üretmek en mantıklısıdır.
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const state = {
    stream: null,
    yaw: null,
    pitch: null,
    targetYaw: 0,
    stepYaw: 30,
    tol: 6,
    layerPitch: 0,
    shots: [] // {dataUrl, yaw, pitch, ts}
  };

  // -------- Utilities
  function normDeg(d){
    let x = d % 360;
    if (x < 0) x += 360;
    return x;
  }
  function angDiff(a, b){
    // minimal difference between angles (0..180)
    let d = Math.abs(normDeg(a) - normDeg(b));
    return Math.min(d, 360 - d);
  }

  function updateUI(){
    $("#yawVal").text(state.yaw == null ? "—" : Math.round(state.yaw));
    $("#pitchVal").text(state.pitch == null ? "—" : Math.round(state.pitch));
    $("#targetText").text(`Hedef: ${Math.round(state.targetYaw)}° | Katman: ${state.layerPitch}°`);

    const ok = (state.yaw != null) && (angDiff(state.yaw, state.targetYaw) <= state.tol) &&
               (state.pitch != null) && (Math.abs(state.pitch - state.layerPitch) <= 12);

    $("#lamp").toggleClass("ok", ok);
    $("#lamp").toggleClass("bad", state.yaw == null);

    $("#progressText").text(`${state.shots.length} kare`);
  }

  function nextTarget(){
    state.stepYaw = Number($("#stepYaw").val());
    state.tol = Number($("#tol").val());
    state.layerPitch = Number($("#layer").val());

    state.targetYaw = normDeg(state.targetYaw + state.stepYaw);
    updateUI();
  }

  function renderThumbs(){
    const $t = $("#thumbs").empty();
    state.shots.forEach((s, i) => {
      const $el = $(`
        <div class="thumb" title="Yaw: ${Math.round(s.yaw)} | Pitch: ${Math.round(s.pitch)}">
          <div class="n">${i+1}</div>
          <img alt="shot ${i+1}" src="${s.dataUrl}">
        </div>
      `);
      $t.append($el);
    });
  }

  // -------- Camera
  async function startCamera(){
    try{
      const constraints = {
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      state.stream = stream;
      const video = document.getElementById("video");
      video.srcObject = stream;
      await video.play();
    } catch(e){
      alert("Kamera açılamadı: " + e.message);
    }
  }

  function stopCamera(){
    if(state.stream){
      state.stream.getTracks().forEach(t => t.stop());
      state.stream = null;
    }
  }

  function captureFrame(){
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;
    canvas.width = w;
    canvas.height = h;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);

    // JPG kalite: 0.85
    const dataUrl = canvas.toDataURL("image/jpeg", 0.85);

    state.shots.push({
      dataUrl,
      yaw: state.yaw ?? 0,
      pitch: state.pitch ?? 0,
      ts: Date.now()
    });

    renderThumbs();
    updateUI();
  }

  // -------- Gyro / orientation
  async function requestGyroPermissionIfNeeded(){
    // iOS 13+ requires permission call in user gesture
    try{
      if (typeof DeviceOrientationEvent !== "undefined" &&
          typeof DeviceOrientationEvent.requestPermission === "function") {
        const res = await DeviceOrientationEvent.requestPermission();
        if(res !== "granted") throw new Error("İzin verilmedi");
      }
      alert("Gyro/Orientation hazır ✅ (telefonu çevirince yaw/pitch güncellenecek)");
    } catch(e){
      alert("Gyro izni alınamadı: " + e.message);
    }
  }

  window.addEventListener("deviceorientation", (ev) => {
    // alpha: z axis rotation (0..360) ~ yaw
    // beta: x axis rotation (-180..180) ~ pitch
    if(ev.alpha == null) return;
    state.yaw = normDeg(ev.alpha);
    state.pitch = ev.beta;
    updateUI();
  }, true);

  // -------- Download single images
  function downloadAll(){
    if(!state.shots.length){ alert("İndirilecek kare yok."); return; }
    state.shots.forEach((s, idx) => {
      const a = document.createElement("a");
      a.href = s.dataUrl;
      a.download = `shot_${String(idx+1).padStart(2,"0")}_yaw${Math.round(s.yaw)}_pitch${Math.round(s.pitch)}.jpg`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  }

  // -------- Upload stub (you will implement backend)
  async function uploadToServer(){
    if(!state.shots.length){ alert("Gönderilecek kare yok."); return; }

    // MVP: JSON (base64) göndermek ağır olabilir.
    // Daha iyisi: dataURL'leri Blob yapıp FormData ile göndermek.
    const fd = new FormData();
    state.shots.forEach((s, idx) => {
      const blob = dataURLtoBlob(s.dataUrl);
      fd.append("images", blob, `shot_${idx+1}.jpg`);
      fd.append("meta", JSON.stringify({index: idx+1, yaw: s.yaw, pitch: s.pitch, ts: s.ts}));
    });

    // TODO: kendi endpoint’in
    const endpoint = "/api/stitch"; // örnek

    try{
      $("#btnUpload").prop("disabled", true).text("Gönderiliyor...");
      const res = await fetch(endpoint, { method: "POST", body: fd });
      if(!res.ok) throw new Error("Sunucu hata: " + res.status);

      // Sunucu tek panorama döndü diyelim:
      // const blob = await res.blob();
      // const url = URL.createObjectURL(blob);
      // window.open(url, "_blank");

      alert("Gönderildi ✅ (backend endpoint’ini bağlaman gerekiyor)");
    } catch(e){
      alert("Upload başarısız: " + e.message + "\nNot: /api/stitch endpoint’i sende olmalı.");
    } finally{
      $("#btnUpload").prop("disabled", false).text("Sunucuya Gönder");
    }
  }

  function dataURLtoBlob(dataUrl){
    const parts = dataUrl.split(",");
    const mime = parts[0].match(/:(.*?);/)[1];
    const bstr = atob(parts[1]);
    let n = bstr.length;
    const u8 = new Uint8Array(n);
    while(n--) u8[n] = bstr.charCodeAt(n);
    return new Blob([u8], {type: mime});
  }

  // -------- Events
  $(function(){
    updateUI();

    $("#btnStart").on("click", startCamera);
    $("#btnGyro").on("click", requestGyroPermissionIfNeeded);

    $("#btnCapture").on("click", () => {
      // hedefe yakın değilse yine de çeksin ama uyarı verelim
      const okYaw = (state.yaw != null) && (angDiff(state.yaw, state.targetYaw) <= state.tol);
      if(!okYaw){
        const go = confirm("Hedef açıya tam yakın değilsin. Yine de çekilsin mi?");
        if(!go) return;
      }
      captureFrame();
    });

    $("#btnNextTarget").on("click", nextTarget);

    $("#btnClear").on("click", () => {
      if(!confirm("Tüm çekimleri silmek istiyor musun?")) return;
      state.shots = [];
      state.targetYaw = 0;
      renderThumbs();
      updateUI();
    });

    $("#btnDownload").on("click", downloadAll);
    $("#btnUpload").on("click", uploadToServer);

    $("#stepYaw, #tol, #layer").on("change input", () => {
      state.stepYaw = Number($("#stepYaw").val());
      state.tol = Number($("#tol").val());
      state.layerPitch = Number($("#layer").val());
      updateUI();
    });
  });
</script>
</body>
</html>
