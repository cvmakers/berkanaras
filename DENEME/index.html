<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Otomatik 360 Çekim (Web)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220; --card:rgba(255,255,255,.08); --border:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.70);
      --ok:#26d07c; --warn:#ffcc00; --bad:#ff5a5f;
    }
    body{ background:var(--bg); color:var(--text); }
    .glass{ background:var(--card); border:1px solid var(--border); border-radius:16px; backdrop-filter: blur(10px); }
    .wrap{ position:relative; overflow:hidden; border-radius:18px; border:1px solid var(--border); background:#050912; }
    video{ width:100%; height:74vh; min-height:420px; object-fit:cover; display:block; }

    /* Top HUD (no buttons) */
    .topbar{
      position:absolute; left:12px; right:12px; top:12px; z-index:5;
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
      pointer-events:none;
    }
    .pill{
      border:1px solid var(--border); background:rgba(0,0,0,.35);
      border-radius:14px; padding:10px 12px; font-weight:600;
      display:flex; gap:10px; align-items:center;
    }
    .lamp{ width:10px; height:10px; border-radius:999px; background:var(--warn); }
    .lamp.ok{ background:var(--ok); box-shadow:0 0 0 6px rgba(38,208,124,.18); }
    .lamp.bad{ background:var(--bad); }
    .smallmuted{ color:var(--muted); font-size:.92rem; }

    /* Target HUD */
    .hud{ position:absolute; inset:0; pointer-events:none; display:grid; place-items:center; }
    .rings{ position:relative; width:min(340px, 78vw); height:min(340px, 78vw); }
    .target-ring{
      position:absolute; left:50%; top:50%;
      width:200px; height:200px; transform:translate(-50%,-50%);
      border-radius:999px;
      border:2px dashed rgba(255,255,255,.32);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.22);
    }
    .target-dot{
      position:absolute; left:50%; top:50%;
      width:14px; height:14px; transform:translate(-50%,-50%);
      border-radius:999px;
      background:rgba(255,255,255,.45);
      box-shadow:0 0 0 10px rgba(255,255,255,.10);
    }
    .aim-dot{
      position:absolute;
      width:16px; height:16px;
      border-radius:999px;
      background:rgba(255,255,255,.92);
      box-shadow:0 0 0 12px rgba(255,255,255,.12);
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      transition: transform .06s linear;
    }

    /* Bottom area */
    .thumbs{ display:flex; gap:10px; overflow:auto; padding:10px; }
    .thumb{ width:110px; height:80px; border-radius:12px; overflow:hidden; border:1px solid var(--border); background:#0b1220; flex:0 0 auto; position:relative; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb .n{ position:absolute; left:6px; top:6px; background:rgba(0,0,0,.45); border:1px solid var(--border); padding:2px 7px; border-radius:10px; font-size:.8rem; }

    /* Finish overlay */
    .finish{
      position:absolute; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 10;
    }
    .finish.show{ display:flex; }
    .finish-card{
      max-width: 520px;
      width: 100%;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(10,18,32,.85);
      backdrop-filter: blur(10px);
      padding: 18px;
    }

    canvas{ display:none; }
  </style>
</head>
<body>

<div class="container py-3">
  <div class="glass p-3 mb-3">
    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <div>
        <div class="h5 mb-1">Tam Otomatik Yönlendirmeli Çekim</div>
        <div class="smallmuted">
          Sayfaya girince otomatik başlar. Hedef daire içine gelince foto kendisi çeker. Bitince “İndir” çıkar.
        </div>
      </div>
      <div class="smallmuted">
        (iPhone Safari: ilk dokunuşta gyro izni isteyebilir)
      </div>
    </div>
  </div>

  <div class="wrap mb-3" id="wrap">
    <div class="topbar">
      <div class="pill">
        <span class="lamp" id="lamp"></span>
        <span id="hintText">Başlatılıyor…</span>
      </div>
      <div class="pill">
        <span>Hedef:</span><span id="targetText">—</span>
        <span class="ms-2">İlerleme:</span><span id="progressText">0/0</span>
      </div>
      <div class="pill">
        <span>Yaw:</span><span id="yawVal">—</span>
        <span class="ms-2">Pitch:</span><span id="pitchVal">—</span>
      </div>
    </div>

    <video id="video" autoplay playsinline muted></video>

    <div class="hud">
      <div class="rings">
        <div class="target-ring"></div>
        <div class="target-dot"></div>
        <div class="aim-dot" id="aimDot"></div>
      </div>
    </div>

    <!-- Finish overlay (only download button) -->
    <div class="finish" id="finish">
      <div class="finish-card">
        <div class="d-flex align-items-center justify-content-between gap-2">
          <div>
            <div class="h5 mb-1">Çekim bitti ✅</div>
            <div class="smallmuted" id="finishText">Toplam 0 kare çekildi.</div>
          </div>
          <button id="btnDownload" class="btn btn-warning btn-lg">İndir</button>
        </div>
        <div class="smallmuted mt-2">
          Not: Bu sayfa kareleri indirir. 360 tek dosya (equirectangular) üretmek için stitching gerekir (sunucuda önerilir).
        </div>
      </div>
    </div>
  </div>

  <div class="glass">
    <div class="p-3 border-bottom" style="border-color: rgba(255,255,255,.12)!important;">
      <div class="fw-bold">Otomatik çekilen kareler</div>
      <div class="smallmuted">İlerledikçe aşağıya düşer.</div>
    </div>
    <div class="thumbs" id="thumbs"></div>
  </div>

  <canvas id="canvas"></canvas>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  /**
   * TAM OTOMATİK AYARLAR
   * - stepYaw: 30 => 12 kare (tek katman)
   * - layers: tek katman (pitch 0) ile başlar; istersen [0, 30, -30] yap
   * - tol: hedef hassasiyeti (derece)
   */
  const CONFIG = {
    stepYaw: 30,
    layers: [0],      // İstersen: [0, 30, -30]
    tolYaw: 5,        // yaw toleransı
    tolPitch: 10,     // pitch toleransı (sensör oynak)
    holdFramesNeed: 10, // hedefte sabit kalma (10 frame ~ 0.6 sn)
    cooldownMs: 1100,   // çekimler arası minimum süre
    jpegQuality: 0.88
  };

  const state = {
    stream: null,
    yaw: null,
    pitch: null,
    targets: [],
    targetIndex: 0,
    shots: [],
    holdFramesOk: 0,
    lastShotAt: 0,
    started: false,
    finished: false
  };

  // ---------- angle helpers
  function normDeg(d){ let x = d % 360; if(x < 0) x += 360; return x; }
  function angDiff(a,b){ let d = Math.abs(normDeg(a)-normDeg(b)); return Math.min(d, 360-d); }
  function currentTarget(){ return state.targets[state.targetIndex] || null; }

  // ---------- UI helpers
  function setHint(t){ $("#hintText").text(t); }
  function setLamp(mode){
    $("#lamp").removeClass("ok bad");
    if(mode==="ok") $("#lamp").addClass("ok");
    if(mode==="bad") $("#lamp").addClass("bad");
  }
  function updateTopUI(){
    $("#yawVal").text(state.yaw==null ? "—" : Math.round(state.yaw));
    $("#pitchVal").text(state.pitch==null ? "—" : Math.round(state.pitch));
    const t = currentTarget();
    $("#targetText").text(t ? `${Math.round(t.yaw)}° / ${t.pitch}°` : "—");
    $("#progressText").text(`${Math.min(state.targetIndex, state.targets.length)}/${state.targets.length}`);
  }

  // ---------- targets
  function buildTargets(){
    state.targets = [];
    const n = Math.round(360 / CONFIG.stepYaw);
    for(const p of CONFIG.layers){
      for(let i=0;i<n;i++){
        state.targets.push({ yaw: normDeg(i*CONFIG.stepYaw), pitch: p });
      }
    }
    state.targetIndex = 0;
    state.holdFramesOk = 0;
    updateTopUI();
  }

  function advanceTarget(){
    state.targetIndex++;
    state.holdFramesOk = 0;

    if(state.targetIndex >= state.targets.length){
      finish();
    } else {
      const t = currentTarget();
      setHint(`Daire içine getir: ${Math.round(t.yaw)}° / ${t.pitch}°`);
      setLamp(null);
      updateTopUI();
    }
  }

  // ---------- aim dot visual mapping
  function updateAimDot(){
    const t = currentTarget();
    const dot = document.getElementById("aimDot");
    if(!t || state.yaw==null || state.pitch==null){
      dot.style.transform = `translate(-50%,-50%)`;
      return;
    }

    const dxDeg = ((normDeg(state.yaw) - normDeg(t.yaw) + 540) % 360) - 180; // -180..180
    const dyDeg = (state.pitch - t.pitch);

    const ringRadius = 78; // px
    const scaleX = ringRadius / Math.max(1, CONFIG.tolYaw * 2.2);
    const scaleY = ringRadius / 12; // pitch mapping (approx)

    let x = dxDeg * scaleX;
    let y = dyDeg * scaleY;

    const max = ringRadius;
    x = Math.max(-max, Math.min(max, x));
    y = Math.max(-max, Math.min(max, y));

    dot.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
  }

  // ---------- camera
  async function startCamera(){
    const constraints = {
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    };
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    state.stream = stream;
    const video = document.getElementById("video");
    video.srcObject = stream;
    await video.play();
  }

  // iOS gyro permission (needs user gesture). We do a "tap anywhere to start" fallback.
  async function ensureGyroPermission(){
    if (typeof DeviceOrientationEvent !== "undefined" &&
        typeof DeviceOrientationEvent.requestPermission === "function") {
      const res = await DeviceOrientationEvent.requestPermission();
      if(res !== "granted") throw new Error("Gyro izni verilmedi");
    }
  }

  function captureFrame(){
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const w = video.videoWidth || 1280;
    const h = video.videoHeight || 720;

    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);

    const dataUrl = canvas.toDataURL("image/jpeg", CONFIG.jpegQuality);
    const t = currentTarget();

    state.shots.push({
      dataUrl,
      yaw: state.yaw ?? 0,
      pitch: state.pitch ?? 0,
      target: t ? { ...t } : null,
      ts: Date.now()
    });

    state.lastShotAt = Date.now();
    renderThumbs();
  }

  function renderThumbs(){
    const $t = $("#thumbs").empty();
    state.shots.forEach((s,i)=>{
      const title = s.target ? `Target ${Math.round(s.target.yaw)}/${s.target.pitch}` : "shot";
      $t.append(`
        <div class="thumb" title="${title}">
          <div class="n">${i+1}</div>
          <img alt="shot ${i+1}" src="${s.dataUrl}">
        </div>
      `);
    });
    $("#progressText").text(`${Math.min(state.targetIndex, state.targets.length)}/${state.targets.length}`);
  }

  // ---------- finish & download
  function finish(){
    state.finished = true;
    setLamp("ok");
    setHint("Çekim bitti ✅");
    $("#finishText").text(`Toplam ${state.shots.length} kare çekildi.`);
    $("#finish").addClass("show");
    updateTopUI();
  }

  function downloadAll(){
    if(!state.shots.length){ alert("İndirilecek kare yok."); return; }
    state.shots.forEach((s, idx) => {
      const a = document.createElement("a");
      a.href = s.dataUrl;
      const ty = s.target ? `T${Math.round(s.target.yaw)}_${s.target.pitch}` : "T";
      a.download = `shot_${String(idx+1).padStart(3,"0")}_${ty}_yaw${Math.round(s.yaw)}_pitch${Math.round(s.pitch)}.jpg`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  }

  // ---------- auto capture loop
  function tick(){
    if(!state.started || state.finished) return;

    const t = currentTarget();
    if(!t) return;

    if(state.yaw == null || state.pitch == null){
      setLamp("bad");
      setHint("Sensör verisi yok. iPhone ise ekrana 1 kez dokun (gyro izni için).");
      updateTopUI();
      updateAimDot();
      return;
    }

    const okYaw = angDiff(state.yaw, t.yaw) <= CONFIG.tolYaw;
    const okPitch = Math.abs(state.pitch - t.pitch) <= CONFIG.tolPitch;
    const ok = okYaw && okPitch;

    updateAimDot();

    if(ok){
      state.holdFramesOk++;
      setLamp("ok");
      setHint(`Hedefte ✅ (${state.holdFramesOk}/${CONFIG.holdFramesNeed}) Sabit tut...`);
    } else {
      state.holdFramesOk = 0;
      setLamp(null);
      setHint(`Daire içine getir: ${Math.round(t.yaw)}° / ${t.pitch}°`);
    }

    const now = Date.now();
    const cooldownOk = (now - state.lastShotAt) > CONFIG.cooldownMs;

    if(ok && cooldownOk && state.holdFramesOk >= CONFIG.holdFramesNeed){
      captureFrame();
      setHint("Çekildi ✅ Sıradaki hedef…");
      advanceTarget();
    }

    updateTopUI();
  }

  // ---------- orientation listener
  window.addEventListener("deviceorientation", (ev) => {
    if(ev.alpha == null) return;
    state.yaw = normDeg(ev.alpha);
    state.pitch = ev.beta; // -180..180
  }, true);

  // ---------- AUTO START
  async function autoStart(){
    if(state.started) return;
    state.started = true;

    try{
      setHint("Kamera açılıyor…");
      await startCamera();

      // build targets after camera starts
      buildTargets();
      const t = currentTarget();
      setHint(t ? `Daire içine getir: ${Math.round(t.yaw)}° / ${t.pitch}°` : "Hazır");

      // Try request gyro permission silently (works on Android; iOS needs gesture)
      try { await ensureGyroPermission(); } catch(e){ /* ignore, we handle tap fallback */ }

      // If iOS needs gesture, let user tap anywhere once (no visible buttons)
      const tapHandler = async () => {
        try{
          await ensureGyroPermission();
          setHint("Gyro izin verildi ✅ Devam et.");
        } catch(e){
          // still not granted; keep hint
        } finally {
          document.removeEventListener("click", tapHandler);
          document.removeEventListener("touchstart", tapHandler);
        }
      };
      document.addEventListener("click", tapHandler, { once:false });
      document.addEventListener("touchstart", tapHandler, { once:false, passive:true });

      // start loop
      setInterval(tick, 60);
    } catch(e){
      alert("Otomatik başlatma başarısız: " + e.message);
      setHint("Başlatılamadı. HTTPS ve izinleri kontrol et.");
      setLamp("bad");
    }
  }

  $(function(){
    $("#btnDownload").on("click", downloadAll);
    autoStart();
  });
</script>
</body>
</html>
